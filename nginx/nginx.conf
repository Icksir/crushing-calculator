events {
    worker_connections 1024;
}

http {
    include       mime.types;
    
    # Rate Limiting Zones
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=general_limit:10m rate=20r/s;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.dofusdu.de;";

    server {
        listen 80;
        server_tokens off; # Hide Nginx version

        # Trust Cloudflare's X-Forwarded-For header
        set_real_ip_from 173.245.48.0/20;
        set_real_ip_from 103.21.244.0/22;
        set_real_ip_from 103.22.200.0/22;
        set_real_ip_from 103.31.4.0/22;
        set_real_ip_from 141.101.64.0/18;
        set_real_ip_from 108.162.192.0/18;
        set_real_ip_from 190.93.240.0/20;
        set_real_ip_from 188.114.96.0/20;
        set_real_ip_from 197.234.240.0/22;
        set_real_ip_from 198.41.128.0/17;
        set_real_ip_from 162.158.0.0/15;
        set_real_ip_from 104.16.0.0/12;
        set_real_ip_from 2400:cb00::/32;
        set_real_ip_from 2606:4700::/32;
        set_real_ip_from 2803:f800::/32;
        set_real_ip_from 2405:b500::/32;
        set_real_ip_from 2405:8100::/32;
        set_real_ip_from 2a06:98c0::/29;
        set_real_ip_from 2c0f:f248::/32;
        real_ip_header X-Forwarded-For;

        # Frontend
        location / {
            limit_req zone=general_limit burst=30 nodelay;
            
            proxy_pass http://crushing-calculator-frontend-1:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_cache_bypass $http_upgrade;
            
            # Important for i18n: preserve the original request path
            proxy_redirect off;
        }

        # Backend API
        location /api {
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass http://crushing-calculator-backend-1:8000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
        
        # Backend Docs
        location /docs {
            limit_req zone=general_limit burst=10 nodelay;
            
            proxy_pass http://crushing-calculator-backend-1:8000/docs;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }
        
        location /redoc {
            limit_req zone=general_limit burst=10 nodelay;
            
            proxy_pass http://crushing-calculator-backend-1:8000/redoc;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }
        
        location /openapi.json {
            proxy_pass http://crushing-calculator-backend-1:8000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }
    }
}
